#!/bin/sh

################################################################################
#
# Generate .desktop files from BlackArch PKGBUILD files
#
################################################################################

################################################################################
# TODO List
# TODO: Add desktop menus for categories
# TODO: modify dependencies to use blackarch-menus
#
################################################################################

VERSION="0.1"
ICON=""

# Get name of executable
#
# Arguments:
#       pkg : PKGBUILD file
#
# Return:
#       name : name of executable
#
get_prog_name()
{
  pkg=$1
  name="$(awk -F '=' '/^_pkgname/ {print $2}' "$pkg")"

  if [ -z "$name" ]; then
    name="$(awk -F '=' '/^pkgname/ {print $2}' "$pkg")"
  fi

  echo "$name"
}

# Get name of pkg
#
# Arguments:
#       pkg : PKGBUILD file
#
# Return:
#       name : name of pkg
#
get_name()
{
  pkg=$1
  name="$(basename "$(dirname "$pkg")")"
  echo "$name"
}

# Get pkg description
#
# Arguments:
#       pkg : PKGBUILD file
#
# Return:
#       comment : comment for desktop file
#
get_desc()
{
  pkg="$1"
  comment="$(awk -F '=' '/pkgdesc/ {print substr($2, 2, length($2) - 2)}' $pkg)"
  echo "$comment"
}


# Extract all the groups to order in categories
#
# Argmuents:
#       pkg : PKGBUILD file
#
# Return:
#       cat : BA menu groups
#
get_groups()
{
  pkg=$1
  groups=$(awk -F '=' '/groups/ { print substr($2, 2, length($2) - 2)}' "$pkg")
  categorie=""
  for group in $groups; do
    case "$group" in
      \'blackarch-anti-forensic\')
        categorie="${categorie} X-Blackarch-Anti-Forensic;"
        ;;
      \'blackarch-automation\')
        categorie="${categorie} X-Blackarch-Automation;"
        ;;
      \'blackarch-automobile\')
        categorie="${categorie} X-Blackarch-Automobile;"
        ;;
      \'blackarch-backdoor\')
        categorie="${categorie} X-Blackarch-Backdoor;"
        ;;
      \'blackarch-binary\')
        categorie="${categorie} X-Blackarch-Binary;"
        ;;
      \'blackarch-bluetooth\')
        categorie="${categorie} X-Blackarch-Bluetooth;"
        ;;
      \'blackarch-Code-audit\')
        categorie="${categorie} X-Blackarch-Code-Audit;"
        ;;
      \'blackarch-cracker\')
        categorie="${categorie} X-Blackarch-Cracker;"
        ;;
      \'blackarch-crypto\')
        categorie="${categorie} X-Blackarch-Crypto;"
        ;;
      \'blackarch-database\')
        categorie="${categorie} X-Blackarch-Database;"
        ;;
      \'blackarch-debugger\')
        categorie="${categorie} X-Blackarch-Debugger;"
        ;;
      \'blackarch-decompiler\')
        categorie="${categorie} X-Blackarch-Decompiler;"
        ;;
      \'blackarch-defensive\')
        categorie="${categorie} X-Blackarch-Defensive;"
        ;;
      \'blackarch-disassembler\')
        categorie="${categorie} X-Blackarch-Disassembler;"
        ;;
      \'blackarch-dos\')
        categorie="${categorie} X-Blackarch-Dos;"
        ;;
      \'blackarch-drone\')
        categorie="${categorie} X-Blackarch-Drone;"
        ;;
      \'blackarch-exploitation\')
        categorie="${categorie} X-Blackarch-Exploitation;"
        ;;
      \'blackarch-fingerprint\')
        categorie="${categorie} X-Blackarch-Fingerprint;"
        ;;
      \'blackarch-firmware\')
        categorie="${categorie} X-Blackarch-Firmware;"
        ;;
      \'blackarch-fuzzer\')
        categorie="${categorie} X-Blackarch-Fuzzer;"
        ;;
      \'blackarch-forensic\')
        categorie="${categorie} X-Blackarch-Forensic;"
        ;;
      \'blackarch-gpu\')
        categorie="${categorie} X-Blackarch-Gpu;"
        ;;
      \'blackarch-hardware\')
        categorie="${categorie} X-Blackarch-Hardware;"
        ;;
      \'blackarch-honeypot\')
        categorie="${categorie} X-Blackarch-Honeypot;"
        ;;
      \'blackarch-ids\')
        categorie="${categorie} X-Blackarch-Ids;"
        ;;
      \'blackarch-keylogger\')
        categorie="${categorie} X-Blackarch-Keylogger;"
        ;;
      \'blackarch-malware\')
        categorie="${categorie} X-Blackarch-Malware;"
        ;;
      \'blackarch-misc\')
        categorie="${categorie} X-Blackarch-Misc;"
        ;;
      \'blackarch-mobile\')
        categorie="${categorie} X-Blackarch-Mobile;"
        ;;
      \'blackarch-mobile-reversing\')
        categorie="${categorie} X-Blackarch-Mobile-Reversing;"
        ;;
      \'blackarch-networking\')
        categorie="${categorie} X-Blackarch-Networking;"
        ;;
      \'blackarch-nfc\')
        categorie="${categorie} X-Blackarch-Nfc;"
        ;;
      \'blackarch-packer\')
        categorie="${categorie} X-Blackarch-Packer;"
        ;;
      \'blackarch-proxy\')
        categorie="${categorie} X-Blackarch-Proxy;"
        ;;
      \'blackarch-radio\')
        categorie="${categorie} X-Blackarch-Radio;"
        ;;
      \'blackarch-recon\')
        categorie="${categorie} X-Blackarch-Recon;"
        ;;
      \'blackarch-reversing\')
        categorie="${categorie} X-Blackarch-Reversing;"
        ;;
      \'blackarch-scan\')
        categorie="${categorie} X-Blackarch-Scan;"
        ;;
      \'blackarch-scanner\')
        categorie="${categorie} X-Blackarch-Scanner;"
        ;;
      \'blackarch-sniffer\')
        categorie="${categorie} X-Blackarch-Sniffer;"
        ;;
      \'blackarch-social\')
        categorie="${categorie} X-Blackarch-Social;"
        ;;
      \'blackarch-spoof\')
        categorie="${categorie} X-Blackarch-Spoof;"
        ;;
      \'blackarch-stego\')
        categorie="${categorie} X-Blackarch-Stego;"
        ;;
      \'blackarch-tunnel\')
        categorie="${categorie} X-Blackarch-Tunnel;"
        ;;
      \'blackarch-unpacker\')
        categorie="${categorie} X-Blackarch-Unpacker;"
        ;;
      \'blackarch-voip\')
        categorie="${categorie} X-Blackarch-Voip;"
        ;;
      \'blackarch-webapp\')
        categorie="${categorie} X-Blackarch-Webapp;"
        ;;
      \'blackarch-windows\')
        categorie="${categorie} X-Blackarch-Windows;"
        ;;
      \'blackarch-wireless\')
        categorie="${categorie} X-Blackarch-Wireless;"
        ;;
    esac
  done
  echo "$categorie"
}


# Add .desktop file to sources
#
# Arguments:
#         pkg: PKGBUILD file
#         name: desktop/icon file name
#
add_source()
{
  pkg="$1"
  name="$2"

  cat "$pkg" |  tr '\n' '\0'\ | \
    sed  "s/\(\x00source=([^)]\+\))/\1\n        \'$name\'\)/" | \
    tr '\0' '\n' > "$pkg.mod"
  mv "$pkg.mod" $pkg
}


# Add blackarch-menus to dependencies
#
# Arguments:
#         pkg: PKGBUILD file
#
add_dep()
{
  pkg="$1"

  cat "$pkg" |  tr '\n' '\0'\ | \
    sed "s/\(\x00depends=([^)]\+\))/\1 \'blackarch-menus\'\)/" | \
    tr '\0' '\n' > "$pkg.mod"
  mv "$pkg.mod" $pkg
}


# Add shasum
#
# Arguments:
#        pkg: PKGBUILD file
#        path: desktop/icon file path
#
add_shasum()
{
  pkg="$1"
  path="$2"

  sum=$(sha512sum $path | awk '{print $1}')
  cat "$pkg" |  tr '\n' '\0'\ | \
    sed "s/\(\x00sha512sums=([^)]\+\))/\1\n            \'$sum\'\)/" | \
    tr '\0' '\n' > "$pkg.mod"
  mv "$pkg.mod" $pkg
}


# Increase pkg release
#
# Arguments:
#        pkg: PKGBUILD file
#
incr_release()
{
  pkg="$1"
  cat $pkg | awk -F'=' '/pkgrel/{$2=$2+1}1' > "$pkg.mod"
  mv "$pkg.mod" $pkg
}


# Add line to PKGBUILD to install .desktop file
#
# Arguments:
#       orig_pkg: PKGBUILD file
#       name: dekstop file name
#
modify_pkgbuild()
{
  orig_pkg="$1"
  name="$2"
  tmp="/tmp/PKGBUILD"

  # add desktop file to install list
  tac "$orig_pkg" | \
    awk '/install/ && ! seen { \
    print "  install -m 644 *.desktop \"$pkgdir/usr/share/applications/\""; \
    seen=1} {print}' | \
    tac > $tmp
  add_dep $tmp
  add_source $tmp $name
  add_shasum $tmp "$(dirname $orig_pkg)/$name"

  if [ ! -z "$ICON" ]; then
    tac $tmp | \
      awk '/install/ && ! seen { \
      print "  install -Dm 644 $ICON \"$pkgdir/usr/share/pixmaps/$pkgname.png\""; \
      seen=1} {print}' | \
      tac > "${tmp}.mod"
    mv "${tmp}.mod" $tmp
    add_source $tmp "$(get_name $orig_pkg).png"
    add_shasum $tmp "$(dirname $orig_pkg)/$(get_name $orig_pkg).png"
  fi

  # add blackarch-menus as dependency
  incr_release $tmp

  mv $tmp $orig_pkg
}

# Write .desktop file
#
# Arguments:
#       pkg : PKGBUILD file
#
write_desktop_file()
{
  pkg="$1"
  name="$(get_name "$pkg")"
  comment="$(get_desc "$pkg")"
  ex_name="$(get_prog_name "$pkg")"
  categories="$(get_groups "$pkg")"
  if [ -z $ICON ]; then
    if [ ! -f "$(dirname $pkg)/${name}.png" ]; then
      icon="utilities-terminal"
    else
      icon="$name"
    fi
  else
    icon=$(basename $ICON)
  fi

  cat > "$(dirname $pkg)/ba-${name}.desktop" << EOF
[Desktop Entry]
Name="$name"
Icon="$icon"
Comment="$comment"
TryExec=/usr/bin$ex_name
Exec=sh -c '/usr/bin/"$ex_name";\$SHELL'
StartupNotify=true
Terminal=true
Type=Application
Categories="$categories"
EOF
  modify_pkgbuild "$pkg" "ba-${name}.desktop"
}

# Generate ba-*.desktop files for all packages
generate_all()
{
  # TODO: change to path/default path
  for pkg in $(awk '/groups/ {print FILENAME}' $(pwd)/../packages/*/PKGBUILD)
  do
    if [ ! -f $(dirname $pkg)/ba-*.desktop ]; then
      write_desktop_file "$pkg"
    fi
  done
}


# Generate desktop files for a certain letter
#
# Arguments:
# letter - generate desktop files for this letter
#
gen_letter()
{
  letter="$1"
  for pkg in $(awk '/groups/ {print FILENAME}' $(pwd)/../packages/"${letter}"*/PKGBUILD)
  do
    BUILDFILE="$(dirname $pkg)/PKGBUILD"
    if [ -z "$(awk '/install .*\.desktop/ {print $0}' $BUILDFILE)" ]; then
      write_desktop_file "$pkg"
    fi
  done
}


# print help
#
call_help()
{
  printf "BlackArchs .desktop generation script\n\n"
  printf "\t -a, --all:\t generate .desktop files for all packages\n"
  printf "\t -h, --help:\t print this help\n"
  printf "\t -i, --icon \t path to icon for application\n"
  printf "\t -p, --pkg:\t generate .desktop file for a given package\n"
  printf "\t -V, --version:\t print version of script\n"
}


# main function
#
# Arguments:
# args - command line arguments
#
main()
{
  args=$@
  options=ahi:l:p:vV
  loptions=all,help,icon:,letter:,pkg:,verbose,version


  ! parsed=$(getopt --options=$options --longoptions=$loptions --name "$0" -- $args)
  if [[ ${PIPESTATUS[0]} -ne 0 ]]; then
      exit $FAILURE
  fi
  eval set -- "$parsed"

  while true; do
    case "$1" in
      -a | --all)
        generate_all
        exit
        ;;
      -h | --help)
        call_help
        exit
        ;;
      -i | --icon)
        ICON="$2"
        shift 2
        ;;
      -l | --letter)
        letter=$2
        shift 2
        ;;
      -p | --pkg)
        write_pkg=$2
        shift 2
        ;;
      -V | --version)
        printf "Version: $VERSION\n"
        exit
        ;;
      --)
        break
        ;;
      *)
        break
        ;;
    esac
  done
  write_desktop_file "$write_pkg"
}

main "$@"
