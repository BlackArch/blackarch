# This file is part of BlackArch Linux ( https://www.blackarch.org/ ).
# See COPYING for license details.

pkgname=openvas-scanner
pkgver=22.4.0
pkgrel=2
pkgdesc='Vulnerability scanning Daemon.'
arch=('x86_64')
groups=('blackarch' 'blackarch-scanner')
url='https://github.com/greenbone/'
license=('GPL')
depends=('gvm-libs' 'redis' 'rsync' 'json-glib' 'libbsd')
makedepends=('git' 'cmake' 'doxygen')
source=("${pkgname}-${pkgver}.tar.gz::https://github.com/greenbone/openvas-scanner/archive/refs/tags/v$pkgver.tar.gz")
sha512sums=('9fa712eedc20ebefafeb4050a1baa7c6016924bd4dc5c22b623d87040c01fce092153ff94185e5ebb3a22a675a2be82c7938fb92514f14d4e981767330c24014')

build() {
  cd "${pkgname}-${pkgver}"

  export INSTALL_PREFIX=/usr/local
  export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig

  cmake "-DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=$INSTALL_PREFIX \
    -DSYSCONFDIR=/etc \
    -DLOCALSTATEDIR=/var \
    -DOPENVAS_FEED_LOCK_PATH=/var/lib/openvas/feed-update.lock \
    -DOPENVAS_RUN_DIR=/run/ospd
    --debug-out ."

  make "-j$(nproc)"
}

package() {
  cd "${pkgname}-${pkgver}"

  install -d "$pkgdir/etc/redis"
  install -d "$pkgdir/etc/openvas"
  install -m 644 $srcdir/${pkgname}-${pkgver}/config/redis-openvas.conf $pkgdir/etc/redis/
  echo "db_address = /run/redis-openvas/redis.sock" | tee -a "$pkgdir/etc/openvas/openvas.conf"

  make DESTDIR="$pkgdir" install
  install -Dm 644 -t "$pkgdir/usr/share/doc/$pkgname/" *.md
}

