# TODO: clean up
# TODO: fix dependencies.
pkgname='wpscan'
pkgver=latest
pkgrel=3
groups=(blackarch blackarch-web-apps)
pkgdesc='A vulnerability scanner which checks the security of WordPress installations using a black box approach'
arch=(i686 x86_64)
url="http://wpscan.org"
license=('GPL3')
depends=()
makedepends=('git' 'rubygems')

_gitroot="https://github.com/wpscanteam/"
_gitname=wpscan

package() {
  cd ${srcdir}
  msg "Connecting to git server...."

  if [ -d ${srcdir}/${_gitname} ] ; then
      cd ${_gitname} && git pull origin
      msg "The local files are updated."
  else
      git clone ${_gitroot}
  fi

  msg "GIT checkout done or server timeout"
#  if [ -d $srcdir/.git ]; then
#    msg 'Updating...'
#    git fetch $srcdir
#  else
#    msg 'Checking out...'
#    git clone $_gitroot $srcdir
#  fi

  cd $srcdir

  install -d $pkgdir/usr/share/wpscan

  cp -a {*,.git} $pkgdir/usr/share/wpscan/
  #find $pkgdir/usr/share/wpscan -type f -exec chmod 644 {} +

  mkdir -p "${pkgdir}"/usr/bin

cat > "${pkgdir}"/usr/bin/wpscan << EOF
#!/bin/bash
cd /usr/share/wpscan
ruby ./wpscan.rb \$@
cd \$OLDPWD
EOF

  chmod 755 "${pkgdir}"/usr/bin/wpscan

  # TODO: stop printing here.
  echo -e '\E[37;41m'"\033[1mTo use 'wpscan' you'll need to run the following commands:\033[0m"
  echo "( cd /usr/share/wpscan; gem install bundler && bundle install --without test development )"
  echo

##  enable the following lines if you want pacman to handle these gems (I do not recommend this...)
#  local _gemdir="$(ruby -rubygems -e'puts Gem.default_dir')"
#  gem install --ignore-dependencies  -i "$pkgdir$_gemdir" typhoeus xml-simple
}
