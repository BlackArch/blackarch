# This fSKIPile is part of BlackArch Linux ( https://www.blackarch.org/ ).
# See COPYING for license details.

# Initial PKGBUILD from AUR.
# Old Maintainer: Niklas Krafczyk <krafczyk.n at gmail dot com>

pkgname=klee
pkgver=3.2
pkgrel=6
pkgdesc='A symbolic virtual machine built on top of the LLVM compiler infrastructure.'
arch=('x86_64' 'aarch64')
url='https://github.com/klee/klee'
license=('custom:UIUC')
groups=('blackarch' 'blackarch-binary' 'blackarch-reversing'
        'blackarch-debugger')
depends=('gperftools' 'z3' 'libcap' 'python' 'llvm-libs' 'klee-uclibc' 'sqlite')
makedepends=('llvm>=15' 'clang==16' 'cmake' 'git' 'gperftools' 'z3')
source=("git+https://github.com/$pkgname/$pkgname.git"
        "https://github.com/google/googletest/archive/refs/tags/v1.16.0.zip")
sha512sums=(
  'SKIP'
  '9e2ce58c9be3a24b877b981b0c848648cd8beb13dfc07799b71c017357bbf9974abd7d2d2c77556d1a935091f9d3d6f1287e4ef54dc1749b2d0ed304f209a305')

prepare() {
  cd $pkgname

  mkdir -p "$srcdir/build"
  cd "$srcdir/build"

  cmake \
    -DENABLE_TCMALLOC=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DENABLE_SYSTEM_TESTS=ON \
    -DENABLE_POSIX_RUNTIME=ON \
    -DENABLE_KLEE_UCLIBC=ON \
    -DKLEE_UCLIBC_PATH=/usr/share/klee-uclibc/usr \
    -DENABLE_SOLVER_Z3=ON \
    -DENABLE_SOLVER_STP=OFF \
    -DENABLE_SOLVER_METASMT=OFF \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_INSTALL_LIBDIR=/usr/lib \
    -DCMAKE_BUILD_TYPE=Release \
    -DGTEST_SRC_DIR="$srcdir/googletest-1.16.0" \
    -DENABLE_UNIT_TESTS=ON \
    -DENABLE_SYSTEM_TESTS=ON \
    "$srcdir/$pkgname"
}

build() {
  cd build

  make $MAKEFLAGS
}

package() {
	cd build

	make DESTDIR="$pkgdir" install

  install -Dm 644 "$srcdir/$pkgname/LICENSE.TXT" \
    "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}

check() {
  make systemtests
}

