# This file is part of BlackArch Linux ( https://www.blackarch.org/ ).
# See COPYING for license details.

pkgname=python-celery
_pkgname=celery
pkgver=5.6.0
pkgrel=1
pkgdesc='Distributed Task Queue.'
arch=('any')
url='https://pypi.org/project/celery/#files'
license=('BSD-3-Clause')
depends=('python')
depends=('python' 'python-billiard' 'python-click-didyoumean'
         'python-click-plugins' 'python-click-repl' 'python-kombu' 'python-pytz'
         'python-vine')
optdepends=('python-cryptography: for celery.security'
            'python-pymongo: for celery.backends.mongodb'
            'python-msgpack: for using the msgpack serializer'
            'python-pyro: for using Pyro4 message transport'
            'python-redis: for celery.backends.redis'
            'python-sqlalchemy: for celery.backends.database'
            'python-boto3: for SQS transport'
            'python-yaml: for using the yaml serializer'
            'python-pyzmq: for using ZeroMQ transport')
makedepends=('python-build' 'python-pip' 'python-wheel')
source=("https://files.pythonhosted.org/packages/source/${_pkgname::1}/$_pkgname/$_pkgname-$pkgver.tar.gz"
        'celery@.service'
        'celery.tmpfiles.d')
sha512sums=('eedf359a6353fde83075a2c6840e316256a4974429e77dbdd6098ddd3ebfa335a3f9b63071acf8da275bc6e90ce23cbe68e80077e56f1783624f28f2283a4eb8')
            '3c6c9dbdacca2de12d49c03526b34797fd867c14d04115af0d1fda64d2848a5d3f64ceb6d284be319a81d932dc86e69c157b6f5f859f2fa213fc2f43a6052c65'
            '67279b75c3b44d065811c9c90aee006296164000912d5bb97c74956b26ee4ad4f0847e846052a896d379848b869c849300367e676d3f689cf29e3a0c7ae5310b')

build() {
  cd "$_pkgname-$pkgver"

  python -m build --wheel --outdir="$startdir/dist"
}

package() {
  cd "$_pkgname-$pkgver"

  pip install \
    --verbose \
    --disable-pip-version-check \
    --no-warn-script-location \
    --ignore-installed \
    --no-compile \
    --no-deps \
    --root="$pkgdir" \
    --prefix=/usr \
    --no-index \
    --find-links="file://$startdir/dist" \
    $_pkgname

  install -Dm 644 "$srcdir/celery@.service" \
    "$pkgdir/usr/lib/systemd/system/celery@.service"
  install -Dm 644 "$srcdir/celery.tmpfiles.d" \
    "$pkgdir/usr/lib/tmpfiles.d/celery.conf"
}

